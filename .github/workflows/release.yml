name: Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Optional semver (e.g. 1.2.3). Leave blank to bump patch."
        required: false
        default: ""
      pre_release:
        description: "Mark as prerelease (bumps prerelease when no version supplied, publishes with next tag)"
        required: false
        type: boolean
        default: false
      release_notes:
        description: "Optional release notes (Markdown). Leave blank to auto-generate."
        required: false
        type: string
        default: ""

permissions:
  contents: write
  id-token: write # OIDC for npm Trusted Publishing

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure up-to-date main & tags
        run: |
          git fetch origin main --tags
          git checkout -B release-tmp origin/main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          registry-url: "https://registry.npmjs.org"
          cache: yarn

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build
        run: yarn build

      - name: Run tests
        run: yarn test

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute next version and check remote tag
        id: version
        env:
          INPUT_VERSION: ${{ github.event.inputs.release_version }}
          PRE_RELEASE: ${{ github.event.inputs.pre_release }}
        shell: bash
        run: |
          set -euo pipefail

          # Resolve desired version number (no leading v)
          if [ -n "${INPUT_VERSION}" ]; then
            CLEAN="${INPUT_VERSION#v}"
          elif [ "${PRE_RELEASE}" = "true" ]; then
            CURRENT=$(node -p "require('./package.json').version")
            CLEAN=$(node -p "require('semver').inc(process.argv[1],'prerelease','rc')" "$CURRENT")
          else
            CURRENT=$(node -p "require('./package.json').version")
            CLEAN=$(node -p "require('semver').inc(process.argv[1],'patch')" "$CURRENT")
          fi

          TAG="v$CLEAN"

          # Fail if tag already exists on origin
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG$"; then
            echo "Tag $TAG already exists on origin. Aborting."
            exit 1
          fi

          echo "value=$CLEAN" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Bump version (annotated tag by npm)
        env:
          VERSION: ${{ steps.version.outputs.value }}
        run: |
          npm version "$VERSION" -m "chore(release): v%s"

      - name: Publish to npm (Trusted Publishing)
        env:
          PRE_RELEASE: ${{ github.event.inputs.pre_release }}
        run: |
          if [ "$PRE_RELEASE" = "true" ]; then
            yarn npm publish --access public --tag next
          else
            yarn npm publish --access public
          fi

      - name: Push version commit and tag (FF onto main)
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          # Ensure we still fast-forward onto latest main
          git fetch origin main
          git rebase origin/main
          git push --force-with-lease origin HEAD:main
          git push origin "$TAG"

      - name: Create GitHub release
        env:
          TAG: ${{ steps.version.outputs.tag }}
          RELEASE_NOTES: ${{ github.event.inputs.release_notes }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ -n "$RELEASE_NOTES" ]; then
            printf "%s" "$RELEASE_NOTES" > release-notes.txt
            gh release create "$TAG" --title "$TAG" --notes-file release-notes.txt --verify-tag
          else
            gh release create "$TAG" --title "$TAG" --generate-notes --verify-tag
          fi
